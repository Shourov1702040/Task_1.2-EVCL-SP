import socket, pickle, struct, traceback, os, time, fe_reconstruct
import Functionalities_ES as Functionalities

# ______________________________ Edge Server Information_________________________________________#

client_id = "Edge-Server-3"
block_size = 512  #KB
data_loc ="C:/My Drive/PHD Works/Task 1/Experiments RM-1/E2VL/replicas"
# replica_ids = ['R-2', 'R-3', 'R-4', 'R-7', 'R-8']

csv_filename = "C:/My Drive/PHD Works/Task 1/Experiments RM-1/E2VL/edge_data.csv"
replica_ids = Functionalities.csv_to_edge_info(csv_filename, client_id)
# print(replica_ids)

Data_replicas = Functionalities.load_replicas_from_dir_ES(data_loc, replica_ids, block_size)

# Data_replicas = Functionalities.Modify_data(Data_replicas, 'R-2', 0)
# d_dad_ = Data_replicas[0][0]
# d_dad = d_dad_.decode('utf-8')
# d_dad = 'd'+d_dad
# Data_replicas[0][0] = d_dad
time_all_ES = []


#______________________________________ Private Function ________________________________________#
def generate_reply_message(challenge_message, client_id, replica_ids, Data_replicas):
    Trees_ES = []
    Roots_ES = []
    G_leafs_ES = []
    block_loc_key = {}
    # print(challenge_message)
    ES_id, sh_key, sec_code, A_info = tuple(challenge_message)
    K_ES_HW = fe_reconstruct.derive_es_key(client_id)

    if client_id != ES_id:
        print(f"[{client_id}] Wrong Edge Server in challenge. Expected {client_id}, got {ES_id}")
        return [client_id, "WrongEdgeID"]

    for index_ss in range(len(Data_replicas)):
        modification_status = False
        # if index_ss==0:
        #     modification_status = True     # Corrupting data
        leafs, hashes = Functionalities.generate_leaf_node(Data_replicas[index_ss], replica_ids[index_ss], sh_key, sec_code, modification_status)
        loc_key = Functionalities.Loc_key_gen(hashes, K_ES_HW, replica_ids[index_ss]) # PUF derived localization key
        tree = Functionalities.build_OMHT(leafs, replica_ids[index_ss], sh_key, sec_code) 
        Trees_ES.append(tree)
        block_loc_key[replica_ids[index_ss]] = loc_key
        # temp_root = Functionalities.PUF_derived_Replica_root(tree[-1], K_ES_HW) #PUF derived proof
        Roots_ES.append(tree[-1])

    # print(Trees_ES[0])
    G_leafs_ES = Functionalities.transform_list(Roots_ES)
    root = Functionalities.build_minimal_tree(G_leafs_ES, A_info, sec_code)
    final_root = Functionalities.PUF_derived_Replica_root(root, K_ES_HW)
    # print(f"---------------block_loc_key---------{block_loc_key}")
    Response_edge = [client_id, final_root, block_loc_key]
    # print(f"Response_edge::::::::::::::::: {Response_edge}")
    return Response_edge

# _________________________________ Main Edge Server setup _______________________________________#
Edge_server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
cloud_server_address = ('127.0.0.1', 12345)
print(f"[{client_id}] Connecting to Cloud_server at {cloud_server_address}")
i=1
try:
    Edge_server.connect(cloud_server_address)
    print(f"[{client_id}] Connected to Cloud_server.")

    Edge_server.sendall(f"{client_id}: Connected".encode())

    while True:
        data = Edge_server.recv(4096)
        if not data:
            print(f"[{client_id}] Cloud_server closed connection.")
            break

        try:
            start_time_RS = time.time()
            message_list = pickle.loads(data)
            # print(f"len of r_ids: {len(replica_ids)}, len of Data replicas: {len(Data_replicas)}")
            # print(f"[{client_id}] Received: {message_list}")
            message_list = list(message_list)
            reply_message = generate_reply_message(message_list, client_id, replica_ids, Data_replicas)

            try:
                # print(f"[{client_id}] Sending reply: {reply_message}") 
                serialized_msg = pickle.dumps(reply_message)
                
                Edge_server.sendall(serialized_msg)
                print(f"[{client_id}] has sent integrity proof to CS")
            except Exception as e:
                print(f"[{client_id}] Error sending reply: {e}")
            i += 1
            time_all_ES.append(time.time() - start_time_RS)
            print(f"Proof generation time: {time_all_ES}")
        except Exception as es:
            traceback.print_exc()
            print(f"[{client_id}] Received non-pickled data. {es}")

except KeyboardInterrupt:
    print(f"\n[{client_id}] Shutting down on user request.")

except Exception as e:
    print(f"[{client_id}] Error: {e}")

finally:
    print(f"[{client_id}] Closing connection.")
    Edge_server.close()
